<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic PWA with Push Notifications</title>
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Test PWA">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }

        #installBtn {
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <h1>test op PWA iOS</h1>
    <p>class org. v12</p>
    <button id="installBtn">Install PWA</button>
    <h1>Console Output in DOM</h1>
    <div id="log"></div>

    <script>
        let deferredPrompt;

        // Install PWA Button Logic
        const installBtn = document.getElementById('installBtn');
        installBtn.style.display = 'none';

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';

            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
            });
        });

        if ('Notification' in window && 'serviceWorker' in navigator && 'PushManager' in window) {

            // Check if the app is installed (standalone mode)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

            if (isStandalone) {
                // Register the Service Worker
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function (swReg) {
                        console.log('Service Worker Registered', swReg);

                        // Check if notification permission is already granted
                        if (Notification.permission === 'granted') {
                            console.log('Notification permission already granted.');
                            subscribeUser(swReg); // Subscribe user to push notifications

                        } else if (Notification.permission === 'default') {
                            // Request notification permission
                            Notification.requestPermission().then(permission => {
                                if (permission === 'granted') {
                                    console.log('Notification permission granted.');
                                    subscribeUser(swReg); // Subscribe user to push notifications
                                } else {
                                    console.log('Notification permission denied.');
                                }
                            });
                        } else {
                            console.log('Notification permission already denied.');
                        }
                    })
                    .catch(function (error) {
                        console.error('Service Worker registration failed:', error);
                    });
            } else {
                console.log('PWA is not installed. Push notifications require installation on iOS.');
            }
        } else {
            console.log('Notifications or PushManager not supported in this browser.');
        }


        // Subscribe user to push notifications
        function subscribeUser(swReg) {
            const applicationServerKey = urlBase64ToUint8Array('BJnbPGrjjnrYgztekgh4nsCvsAq0paddz14gVBWxK2UNSmNuHYYC2GwWslweVPksmlmKwttLc0d3qpvQ2AX_LgM');  // Replace with your VAPID public key
            swReg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: applicationServerKey
            })
                .then(function (subscription) {
                    console.log('User is subscribed:', subscription);

                    const endpoint = subscription.endpoint;
                    const auth = btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh'))));
                    const p256dh = btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))));

                    // Extract the keys from the subscription object
                    const subscriptionObject = {
                        endpoint: endpoint,
                        keys: {
                            p256dh: p256dh,
                            auth: auth
                        }
                    };

                    const node = document.createTextNode("ep: " + endpoint);
                    document.body.appendChild(node);
                    document.body.appendChild(document.createElement("br"));
                    const node2 = document.createTextNode("p256dh: " + p256dh);
                    document.body.appendChild(node2);
                    document.body.appendChild(document.createElement("br"));
                    const node3 = document.createTextNode("auth: " + auth);
                    document.body.appendChild(node3);
                    document.body.appendChild(document.createElement("br"));

                    console.log('Subscription details:', subscriptionObject);

                    // Send the subscription object to your backend for storing and later use
                    sendSubscriptionToServer(subscriptionObject);
                })
                .catch(function (err) {
                    console.error('Failed to subscribe user: ', err);
                });
        }


        // Helper function to convert VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Send subscription object to your backend
        function sendSubscriptionToServer(subscription) {
            // You will need to implement this function to send the subscription to your server
            console.log('Subscription sent to server:', subscription);
            // Make an API request to store the subscription on your server
        }

        const logContainer = document.getElementById('log');

        function logToDOM(level, message) {
            const logMessage = document.createElement('div');
            logMessage.textContent = message;

            if (level === 'error') {
                logMessage.classList.add('error');
            } else if (level === 'warn') {
                logMessage.classList.add('warn');
            }

            logContainer.appendChild(logMessage);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Capture console.log
        const originalConsoleLog = console.log;
        console.log = function (...args) {
            originalConsoleLog.apply(console, args);
            logToDOM('log', args.join(' '));
        };

        // Capture console.warn
        const originalConsoleWarn = console.warn;
        console.warn = function (...args) {
            originalConsoleWarn.apply(console, args);
            logToDOM('warn', args.join(' '));
        };

        // Capture console.error
        const originalConsoleError = console.error;
        console.error = function (...args) {
            originalConsoleError.apply(console, args);
            logToDOM('error', args.join(' '));
        };

        // Capture uncaught errors
        window.onerror = function (message, source, lineno, colno, error) {
            const errorMessage = `Error: ${message} at ${source}:${lineno}:${colno}`;
            console.error(errorMessage);  // Log to console
            logToDOM('error', errorMessage);  // Log to DOM
            return true; // Prevent the default browser error handling
        };

        // Example usage
        console.log('This is a regular log message.');
        console.warn('This is a warning message.');
        console.error('This is an error message.');
    </script>
</body>

</html>